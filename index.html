<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TOUR CLUB</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles (No changes needed here) --- */
        :root {
            --primary-bg: #0F172A;
            /* Dark blue-gray */
            --secondary-bg: #1E293B;
            /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            /* Light gray for primary text */
            --text-secondary: #94A3B8;
            /* Muted gray for secondary text */
            --accent-color: #FACC15;
            /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            /* Blue for primary actions */
            --border-color: #334155;
            /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            /* Green for success */
            --danger-color: #EF4444;
            /* Red for danger/errors */
            --warning-color: #F59E0B;
            /* Orange for warnings */
            --info-color: #3B82F6;
            /* Blue for info */
        }

        /* ... (Rest of the CSS styles remain exactly the same) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            padding-top: 70px;
            padding-bottom: 75px;
            min-height: 100vh;
            overflow-x: hidden;
            /* Added to prevent horizontal scroll from modals */
            overscroll-behavior-y: contain;
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
        }

        a:hover {
            color: #FBBF24;
        }

        .main-content {
            padding: 15px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .custom-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .btn-custom {
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 15px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }

        .btn-custom-primary {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .btn-custom-primary:hover {
            background-color: #2563EB;
        }

        .btn-custom-secondary {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-custom-secondary:hover {
            background-color: #334155;
        }

        .btn-custom-accent {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
        }

        .btn-custom-accent:hover {
            filter: brightness(1.1);
        }

        .btn-custom-link {
            background: none;
            border: none;
            color: var(--primary-button-bg);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0;
            cursor: pointer;
        }

        .text-accent {
            color: var(--accent-color);
        }

        .text-success {
            color: var(--success-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .form-control {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
        }

        .form-control:focus {
            background-color: var(--primary-bg);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert {
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .list-group-item {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .list-group-item i:first-child {
            color: var(--accent-color);
            margin-right: 15px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .list-group-item .bi-chevron-right {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #globalLoaderEl {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner-border {
            color: var(--accent-color);
            width: 3rem;
            height: 3rem;
        }

        .placeholder-glow .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            animation: placeholder-glow 2s ease-in-out infinite;
        }

        .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
        }

        @keyframes placeholder-glow {
            0% {
                background-color: rgba(51, 65, 85, 0.5);
            }

            50% {
                background-color: rgba(51, 65, 85, 0.7);
            }

            100% {
                background-color: rgba(51, 65, 85, 0.5);
            }
        }

        .interactive-list-item {
            cursor: pointer;
        }

        .referral-code {
            font-family: monospace;
            letter-spacing: 1px;
            user-select: all;
        }

        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 5px;
            /* Added margin for spacing */
            object-fit: cover;
            border: 1px solid var(--accent-color);
        }

        .header-title {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .header-title span {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        .header-back-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            margin-right: 5px;
            display: none;
            padding: 5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 1.3rem;
            color: var(--text-primary);
            position: relative;
            background: none;
            border: none;
            padding: 0;
        }

        .notification-badge {
            position: absolute;
            top: -3px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.6rem;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .wallet-chip {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 700;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .wallet-chip i {
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .header-game-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 10px;
            display: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: var(--bottom-nav-bg);
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            flex-grow: 1;
            padding: 8px 0;
            transition: color 0.2s ease, background-color 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            line-height: 1;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
        }

        .nav-item.active {
            color: var(--accent-color);
            background-color: rgba(250, 204, 21, 0.1);
        }

        .swiper-container#promotionSliderEl {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            margin-bottom: 25px;
            --swiper-pagination-color: var(--accent-color);
            --swiper-pagination-bullet-inactive-color: var(--text-secondary);
            --swiper-pagination-bullet-size: 8px;
        }

        .swiper-slide {
            background-color: var(--secondary-bg);
            border-radius: 10px;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .game-card {
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            padding: 0;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .game-card img {
            width: 100%;
            height: 130px;
            object-fit: cover;
            display: block;
        }

        .game-card span {
            display: block;
            padding: 10px 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .tournament-tabs {
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-bg);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .tab-item {
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 8px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 6px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .tab-item.active {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .tab-item i {
            margin-right: 5px;
        }

        .tournament-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .tournament-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tournament-card-tags span {
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid var(--border-color);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .tournament-card-timer {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .tournament-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .tournament-card-title i {
            color: var(--accent-color);
        }

        .tournament-card-info {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            border-top: 1px dashed var(--border-color);
            border-bottom: 1px dashed var(--border-color);
            padding: 10px 0;
            margin: 10px 0;
            font-size: 0.8rem;
        }

        .info-item {
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .info-item span {
            display: block;
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .info-item strong {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .info-item .prize-icon {
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .tournament-card-spots {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .tournament-card-spots span {
            font-weight: 600;
        }

        .progress {
            height: 6px;
            background-color: var(--primary-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            background-color: var(--warning-color);
            transition: width 0.3s ease;
        }

        .tournament-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .tournament-card-actions .btn-sm {
            padding: 8px 10px;
            font-size: 0.85rem;
            width: 100%;
        }

        .tournament-card-actions .btn-join {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-details {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            grid-column: 1 / 2;
        }

        .tournament-card-actions .btn-joined {
            background-color: var(--success-color);
            color: var(--text-primary);
            opacity: 0.8;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-disabled {
            background-color: var(--secondary-bg);
            opacity: 0.6;
            cursor: not-allowed;
            grid-column: 2 / 3;
        }

        .btn-idpass {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            border: none;
            font-weight: 600;
        }

        .wallet-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .wallet-card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .balance-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .balance-item-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .balance-item-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .balance-item-action {
            min-width: 100px;
            text-align: right;
        }

        .balance-item-action .btn-custom-link {
            font-size: 0.85rem;
            color: var(--accent-color);
            padding: 5px;
        }

        .balance-item-action .btn-withdraw {
            background-color: var(--primary-button-bg);
            color: #fff;
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 5px;
            border: none;
        }

        #recentTransactionsListEl .custom-card {
            background-color: var(--secondary-bg);
        }

        #earnings-section .custom-card {
            text-align: center;
        }

        #earnings-section .display-4 {
            font-size: 3rem;
        }

        #earnings-section p strong {
            color: var(--text-primary);
        }

        .profile-header-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid var(--accent-color);
            object-fit: cover;
            background-color: var(--primary-bg);
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .profile-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            word-break: break-all;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-item strong {
            display: block;
            font-size: 1rem;
            font-weight: 600;
        }

        .stat-item span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .profile-links .list-group {
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .profile-links .form-switch .form-check-input {
            background-color: var(--secondary-bg);
            border-color: var(--border-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3csvg%3e");
        }

        .profile-links .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
        }

        #login-section {
            margin-top: 5vh;
        }

        #login-section .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        #login-section .btn-primary {
            background-color: var(--primary-button-bg);
            border: none;
        }

        #login-section .btn-link {
            background: none;
            border: none;
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.9em;
            padding: 5px 0;
        }

        #login-section .btn-link:hover {
            text-decoration: underline;
        }

        #login-section .btn-success {
            background-color: var(--success-color);
            border: none;
        }

        #login-section .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }

        #login-section .form-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: var(--text-secondary);
        }

        #login-section .form-divider::before,
        #login-section .form-divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: var(--border-color);
        }

        #login-section .form-divider::before {
            left: 0;
        }

        #login-section .form-divider::after {
            right: 0;
        }

        #login-section .form-divider span {
            background-color: var(--card-bg);
            padding: 0 10px;
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
            font-weight: 500;
        }

        #login-section .card-title {
            color: var(--text-primary);
        }

        #googleSignInBtnMainEl {
            display: none;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-footer {
            border-top-color: var(--border-color);
        }

        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-body .phonepe-number {
            color: var(--warning-color);
            font-weight: bold;
            user-select: text;
        }

        #matchDetailsModalBodyEl pre {
            background-color: var(--primary-bg);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #policyModalBodyEl {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        #idPasswordModalEl .copy-btn {
            padding: 2px 6px;
            font-size: 0.8rem;
            margin-left: 8px;
            vertical-align: middle;
        }

        #policyModalBodyEl .copy-btn,
        #policyModalBodyEl #shareReferralBtn {
            padding: 4px 10px;
            font-size: 0.9rem;
        }

        #policyModalBodyEl #shareReferralBtn i,
        #policyModalBodyEl .copy-btn i {
            margin-right: 5px;
        }

        #securityWarning {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px;
            z-index: 999;
            border-bottom: 1px solid #a51d1d;
        }

        #securityWarning a {
            color: #ffdddd;
            text-decoration: underline;
        }

        #securityWarning button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            margin-left: 15px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- NEW CSS for Deposit/Withdraw Section (shared styles) --- */
        .deposit-section-container,
        .withdraw-section-container {
            /* Added .withdraw-section-container */
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 0;
        }

        .deposit-page-title,
        .withdraw-page-title {
            /* Added .withdraw-page-title */
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: var(--accent-color);
        }

        .payment-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            justify-content: center;
            /* Center tabs */
            background-color: var(--card-bg);
            /* Match card background */
            border-radius: 8px;
            overflow: hidden;
        }

        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            flex-grow: 1;
            text-align: center;
            background: none;
            border: none;
        }

        .tab-link:hover {
            color: var(--text-primary);
        }

        .tab-link.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background-color: var(--primary-bg);
            /* Slightly darker when active */
        }

        .tab-content {
            display: none;
            padding: 20px;
            /* Add padding for content */
            background-color: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
            /* Reuse existing fadeIn */
        }

        .payment-info {
            background: var(--primary-bg);
            /* Darker background for info */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-color);
            color: var(--text-primary);
        }

        .payment-info p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .payment-info strong {
            font-size: 1.1rem;
            color: var(--accent-color);
            display: block;
            margin-top: 5px;
        }

        /* Make strong more prominent */
        .form-group {
            margin-bottom: 15px;
            /* Slightly less margin */
        }

        .deposit-form .btn,
        .withdraw-form .btn {
            /* Added .withdraw-form .btn */
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
        }

        .deposit-form .btn:hover,
        .withdraw-form .btn:hover {
            /* Added .withdraw-form .btn:hover */
            filter: brightness(1.1);
        }

        /* Error message specific to deposit/withdraw forms */
        .deposit-form .error-message,
        .withdraw-form .error-message {
            /* Added .withdraw-form .error-message */
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 10px;
            min-height: 1.2em;
            text-align: center;
        }

        /* New style for dynamic withdrawal rules */
        #withdrawRulesDisplayEl {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            /* Preserves newlines from admin text */
        }

        /* New styles for Admin Support Modal */
        .admin-support-modal-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .admin-support-modal-icons a {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            transition: color 0.2s ease, transform 0.2s ease;
            text-decoration: none;
            width: 80px;
            /* Fixed width for better alignment */
        }

        .admin-support-modal-icons a:hover {
            color: var(--accent-color);
            transform: translateY(-3px);
        }

        .admin-support-modal-icons i {
            font-size: 2.5rem;
            margin-bottom: 5px;
            color: var(--primary-button-bg);
            /* Default icon color */
        }

        /* Specific icon colors for branding */
        .admin-support-modal-icons .bi-facebook {
            color: #1877F2;
        }

        /* Changed to use Font Awesome for TikTok/Twitter/Instagram for better branding */
        .admin-support-modal-icons .fa-tiktok {
            color: #EE1D52;
        }

        .admin-support-modal-icons .fa-twitter {
            color: #1DA1F2;
        }

        .admin-support-modal-icons .fa-instagram {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-support-modal-icons .bi-envelope-fill {
            color: #EA4335;
        }

        .admin-support-modal-icons .bi-telegram {
            color: #229ED9;
        }

        .admin-support-modal-icons .bi-whatsapp {
            color: #25D366;
        }

        /* Styles for Player Mode Selection Modal */
        #playerModeOptionsContainer button {
            font-size: 1rem;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Leaderboard Specific Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .leaderboard-rank {
            width: 30px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-right: 15px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
        }

        .leaderboard-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-winnings {
            font-weight: 700;
            font-size: 1rem;
            color: var(--accent-color);
            margin-left: 10px;
            min-width: 70px;
            /* Ensure space for winnings */
            text-align: right;
        }

        /* Top 3 Player Styles */
        .leaderboard-item.top-1 {
            background: linear-gradient(90deg, rgba(250, 204, 21, 0.15) 0%, rgba(250, 204, 21, 0) 100%);
            border-left: 5px solid var(--accent-color);
            font-size: 1.05rem;
            padding: 15px;
        }

        .leaderboard-item.top-1 .leaderboard-rank,
        .leaderboard-item.top-1 .leaderboard-name,
        .leaderboard-item.top-1 .leaderboard-winnings {
            color: var(--accent-color);
        }

        .leaderboard-item.top-1 .leaderboard-avatar {
            border-color: var(--accent-color);
        }

        .leaderboard-item.top-2 {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.1) 0%, rgba(148, 163, 184, 0) 100%);
            border-left: 5px solid var(--text-secondary);
            font-size: 1rem;
        }

        .leaderboard-item.top-2 .leaderboard-rank,
        .leaderboard-item.top-2 .leaderboard-name,
        .leaderboard-item.top-2 .leaderboard-winnings {
            color: var(--text-primary);
        }

        .leaderboard-item.top-2 .leaderboard-avatar {
            border-color: var(--text-secondary);
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(90deg, rgba(160, 82, 45, 0.1) 0%, rgba(160, 82, 45, 0) 100%);
            /* Bronze-like */
            border-left: 5px solid #a0522d;
            font-size: 1rem;
        }

        .leaderboard-item.top-3 .leaderboard-rank,
        .leaderboard-item.top-3 .leaderboard-name,
        .leaderboard-item.top-3 .leaderboard-winnings {
            color: var(--text-primary);
        }

        .leaderboard-item.top-3 .leaderboard-avatar {
            border-color: #a0522d;
        }

        .leaderboard-item .leaderboard-rank.icon-rank {
            font-size: 1.4rem;
            /* For medal icons */
            width: 40px;
        }
    </style>
</head>

<body>
    <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are
        insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn
            how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo"
                id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span>
            </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span
                    class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i
                    class="bi bi-wallet-fill"></i> ৳<span id="headerChipBalanceEl">0</span> </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
            <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input
                                    type="email" class="form-control" id="loginEmailInputEl"
                                    placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPasswordInputEl"
                                    placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button"
                                    class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block"
                                    id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#"
                                    id="forgotPasswordLinkEl" class="text-center small mt-2 d-block"
                                    style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3">
                                <label for="signupNameInputEl" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="signupNameInputEl"
                                    placeholder="Enter your name" required>
                            </div>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input
                                    type="email" class="form-control" id="signupEmailInputEl"
                                    placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6
                                    chars)</label> <input type="password" class="form-control"
                                    id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm
                                    Password</label> <input type="password" class="form-control"
                                    id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <!-- *** REFERRAL CODE INPUT ADDED *** -->
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code
                                    (Optional)</label> <input type="text" class="form-control"
                                    id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button"
                                    class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block"
                                    id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder"
                            style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <!-- Placeholder Contest Card -->
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"
                        style="height: 18px;"></span> <span class="placeholder col-12 mt-2"
                        style="height: 24px;"></span> <span class="placeholder col-10 mt-2"
                        style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't
                    joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i
                        class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item"
                    data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button
                    class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"
                        style="height: 18px;"></span> <span class="placeholder col-12 mt-2"
                        style="height: 24px;"></span> <span class="placeholder col-10 mt-2"
                        style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
            </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No
                tournaments found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span
                        class="balance-item-value" id="walletTotalBalanceEl"><span
                            class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History
                            <i class="bi bi-chevron-right"></i></button> </div>
                </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span
                        class="balance-item-value" id="walletWinningCashEl"><span
                            class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-withdraw" id="withdrawBtnEl">Withdraw</button>
                    </div>
                </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span
                        class="balance-item-value" id="walletBonusCashEl"><span
                            class="placeholder col-3"></span></span>
                    <div class="balance-item-action" style="min-width: 100px;"></div>
                </div>
                <button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl"> <i
                        class="bi bi-plus-circle-fill me-2"></i>Add Amount </button>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow">
                <div class="custom-card p-2 mb-2 placeholder-glow">
                    <div class="d-flex justify-content-between"> <span class="placeholder col-5"
                            style="height: 16px;"></span> <span class="placeholder col-3"
                            style="height: 16px;"></span> </div>
                    <div class="small text-secondary mt-1"><span class="placeholder col-6"
                            style="height: 14px;"></span></div>
                </div>
                <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading
                    transactions...</p>
            </div>
        </section>

        <!-- NEW Deposit Section -->
        <section id="deposit-section" class="section">
            <div class="deposit-section-container">
                <h1 class="deposit-page-title">Add Money to Wallet</h1>

                <div class="payment-tabs" id="depositPaymentTabsContainer">
                    <button class="tab-link active" data-tab-target="bkash-tab">Bkash</button>
                    <button class="tab-link" data-tab-target="nagad-tab">Nagad</button>
                    <button class="tab-link" data-tab-target="rocket-tab">Rocket</button>
                </div>

                <div id="bkash-tab" class="tab-content active">
                    <div class="payment-info">
                        <p>আমাদের Bkash নম্বরে টাকা পাঠান:</p>
                        <strong id="bkash-number">Loading...</strong>
                        <p style="margin-top:10px;">সর্বনিম্ন জমার পরিমাণ: <strong>৳ <span
                                    class="min-deposit-display">...</span></strong></p>
                        <p style="color: var(--danger-color); font-size: 0.9em; margin-top: 10px;">
                            গুরুত্বপূর্ণ: শুধুমাত্র উপরে প্রদর্শিত নম্বরে টাকা পাঠান। অন্য নম্বরে পাঠানো টাকা ফেরতযোগ্য
                            নয়।
                        </p>
                    </div>
                    <form class="deposit-form" data-method="Bkash">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ " required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="বিকাশ ট্রানজেকশন আইডি " required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">বিকাশ ডিপোজিট জমা দিন</button>
                    </form>
                </div>

                <div id="nagad-tab" class="tab-content d-none">
                    <div class="payment-info">
                        <p>আমাদের Nagad নম্বরে টাকা পাঠান:</p>
                        <strong id="nagad-number">Loading...</strong>
                        <p style="margin-top:10px;">সর্বনিম্ন জমার পরিমাণ: <strong>৳ <span
                                    class="min-deposit-display">...</span></strong></p>
                        <p style="color: var(--danger-color); font-size: 0.9em; margin-top: 10px;">
                            গুরুত্বপূর্ণ: শুধুমাত্র উপরে প্রদর্শিত নম্বরে টাকা পাঠান। অন্য নম্বরে পাঠানো টাকা ফেরতযোগ্য
                            নয়।
                        </p>
                    </div>
                    <form class="deposit-form" data-method="Nagad">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ" required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="নগদ ট্রানজেকশন আইডি " required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">নগদ ডিপোজিট জমা দিন</button>
                    </form>
                </div>

                <div id="rocket-tab" class="tab-content d-none">
                    <div class="payment-info">
                        <p>আমাদের Rocket নম্বরে টাকা পাঠান:</p>
                        <strong id="rocket-number">Loading...</strong>
                        <p style="margin-top:10px;">সর্বনিম্ন জমার পরিমাণ: <strong>৳ <span
                                    class="min-deposit-display">...</span></strong></p>
                        <p style="color: var(--danger-color); font-size: 0.9em; margin-top: 10px;">
                            গুরুত্বপূর্ণ: শুধুমাত্র উপরে প্রদর্শিত নম্বরে টাকা পাঠান। অন্য নম্বরে পাঠানো টাকা ফেরতযোগ্য
                            নয়।
                        </p>
                    </div>
                    <form class="deposit-form" data-method="Rocket">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ" required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="রকেট ট্রানজেকশন আইডি " required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">রকেট ডিপোজিট জমা দিন</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- NEW Withdraw Section -->
        <section id="withdraw-section" class="section">
            <div class="withdraw-section-container">
                <h1 class="withdraw-page-title">Withdraw Funds</h1>

                <!-- Dynamic Withdrawal Rules Display -->
                <div id="withdrawRulesDisplayEl" class="mb-4">
                    <!-- Rules will be loaded here from appSettings.policyWithdrawal -->
                    টাকা তোলার নিয়মাবলী লোড হচ্ছে...
                </div>

                <div class="payment-tabs" id="withdrawPaymentTabsContainer">
                    <button class="tab-link active" data-tab-target="bkash-withdraw-tab">Bkash</button>
                    <button class="tab-link" data-tab-target="nagad-withdraw-tab">Nagad</button>
                    <button class="tab-link" data-tab-target="rocket-withdraw-tab">Rocket</button>
                </div>

                <div id="bkash-withdraw-tab" class="tab-content active">
                    <div class="payment-info">
                        <p>আপনার Bkash নম্বরে টাকা তুলতে:</p>
                        <p style="margin-top:5px;">সর্বনিম্ন তোলার পরিমাণ: <strong>৳ <span
                                    class="min-withdraw-display-amount">...</span></strong></p>
                        <p style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">
                            আপনার ব্যক্তিগত বিকাশ নম্বরটি নিচের ইনপুট ফিল্ডে প্রবেশ করান।
                        </p>
                    </div>
                    <form class="withdraw-form" data-method="Bkash">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ" required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="আপনার বিকাশ নম্বর" required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">বিকাশ থেকে টাকা তুলুন</button>
                    </form>
                </div>

                <div id="nagad-withdraw-tab" class="tab-content d-none">
                    <div class="payment-info">
                        <p>আপনার Nagad নম্বরে টাকা তুলতে:</p>
                        <p style="margin-top:5px;">সর্বনিম্ন তোলার পরিমাণ: <strong>৳ <span
                                    class="min-withdraw-display-amount">...</span></strong></p>
                        <p style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">
                            আপনার ব্যক্তিগত নগদ নম্বরটি নিচের ইনপut ফিল্ডে প্রবেশ করান।
                        </p>
                    </div>
                    <form class="withdraw-form" data-method="Nagad">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ" required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="আপনার নগদ নম্বর" required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">নগদ থেকে টাকা তুলুন</button>
                    </form>
                </div>

                <div id="rocket-withdraw-tab" class="tab-content d-none">
                    <div class="payment-info">
                        <p>আপনার Rocket নম্বরে টাকা তুলতে:</p>
                        <p style="margin-top:5px;">সর্বনিম্ন তোলার পরিমাণ: <strong>৳ <span
                                    class="min-withdraw-display-amount">...</span></strong></p>
                        <p style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">
                            আপনার ব্যক্তিগত রকেট নম্বরটি নিচের ইনপুট ফিল্ডে প্রবেশ করান।
                        </p>
                    </div>
                    <form class="withdraw-form" data-method="Rocket">
                        <div class="form-group">
                            <input type="number" class="form-control" placeholder="পরিমাণ" required>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="আপনার রকেট নম্বর" required>
                        </div>
                        <div class="error-message"></div>
                        <button type="submit" class="btn">রকেট থেকে টাকা তুলুন</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Earnings Section -->
        <section id="earnings-section" class="section">
            <h2 class="section-title">Earnings</h2>
            <div class="custom-card text-center">
                <i class="bi bi-coin display-4 text-accent mb-3"></i>
                <p class="text-secondary mb-4">Track your earnings from tournaments and referrals here.</p>
                <div class="placeholder-glow">
                    <p>Total Earned: <strong id="earningsTotalEl"><span class="placeholder col-3"></span></strong></p>
                    <p>From Referrals: <strong id="earningsReferralEl"><span class="placeholder col-3"></span></strong>
                    </p>
                </div>
                <button class="btn btn-custom btn-custom-link mt-3" id="viewEarningsHistoryBtn">View History</button>
            </div>
        </section>

        <!-- NEW Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title text-center mb-4">🏆 Leaderboard 🏆</h2>
            <div id="leaderboardListEl" class="list-group custom-card">
                <p class="text-secondary text-center p-3" id="loadingLeaderboardMessage">Loading Top 20 Players...</p>
                <!-- Placeholder items -->
                <div class="leaderboard-item d-flex align-items-center placeholder-glow">
                    <span class="placeholder rounded-circle me-3" style="width: 40px; height: 40px;"></span>
                    <span class="placeholder col-6 me-auto" style="height: 20px;"></span>
                    <span class="placeholder col-2" style="height: 20px;"></span>
                </div>
                <div class="leaderboard-item d-flex align-items-center placeholder-glow">
                    <span class="placeholder rounded-circle me-3" style="width: 40px; height: 40px;"></span>
                    <span class="placeholder col-7 me-auto" style="height: 20px;"></span>
                    <span class="placeholder col-2" style="height: 20px;"></span>
                </div>
            </div>
            <p class="text-secondary text-center mt-3" id="noLeaderboardMessage" style="display: none;">No players on
                the leaderboard yet.</p>
        </section>


        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                <h3 class="profile-name mt-2" id="profileNameEl">
                    <span class="placeholder col-6"></span>
                    <!-- Previous Change Name Button REMOVED -->
                </h3>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100">
                    <div class="stat-item">
                        <strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong>
                        <span>Matches Played</span>
                    </div>
                    <div class="stat-item">
                        <strong id="profileTotalWinningsEl"><span class="placeholder col-4"></span></strong>
                        <span>Total Winnings</span>
                    </div>
                    <div class="stat-item">
                        <strong id="profileTotalBalanceEl"><span class="placeholder col-4"></span></strong>
                        <span>Total Balance</span>
                    </div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                        <span><i class="bi bi-bell-fill"></i> Notifications</span>
                        <div class="form-check form-switch"> <input class="form-check-input" type="checkbox"
                                role="switch" id="notificationSwitchEl" checked> </div>
                    </label>

                    <!-- NEW: Edit Profile Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        id="editProfileLink">
                        <span><i class="bi bi-person-circle"></i> Edit Profile</span> <i
                            class="bi bi-chevron-right"></i>
                    </a>

                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i
                            class="bi bi-chevron-right"></i> </a>
                    <!-- NEW Leaderboard Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        id="leaderboardLink">
                        <span><i class="bi bi-trophy-fill"></i> Leaderboard</span>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and
                                Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <!-- NEW: Admin Support Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        id="adminSupportLink"> <span><i class="bi bi-headset"></i> Admin Support</span> <i
                            class="bi bi-chevron-right"></i> </a>

                    <!-- DEVELOPER PROFILE LINK ADDED HERE -->
                    <a href="https://t.me/ROMEOVAY" target="_blank" rel="noopener noreferrer"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                        <span><i class="bi bi-code-slash"></i> Developer Profile</span> <i
                            class="bi bi-box-arrow-up-right"></i>
                    </a>

                    <button
                        class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item"
                        id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span>
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="policyModalTitleEl">Details обучение</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>
    <!-- Removed Old Withdraw Modal: <div class="modal fade" id="withdrawModalEl" tabindex="-1">...</div> -->
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchDetailsModalBodyEl"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room ID & Password</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Room ID:</p>
                        <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span
                                class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl"
                            title="Copy Room ID"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Password:</p>
                        <h4 id="roomPasswordDisplayEl"
                            class="text-accent referral-code placeholder-glow d-inline-block">
                            <span class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl"
                            title="Copy Password"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW Match Type Selection Modal -->
    <div class="modal fade" id="playerModeSelectionModalEl" tabindex="-1"
        aria-labelledby="playerModeSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerModeSelectionModalLabel">টুর্নামেন্টে কিভাবে যোগ দেবেন?</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-secondary mb-4" id="playerModeSelectionDescription">এই টুর্নামেন্টটি একাধিক মোড সমর্থন
                        করে। আপনি কোন মোডে যোগ দিতে চান?</p>
                    <div class="d-grid gap-3" id="playerModeOptionsContainer">
                        <!-- Dynamic buttons for Solo, Duo, Squad will be added here by JS -->
                    </div>
                    <div class="error-message mt-3" id="playerModeSelectionErrorEl" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">বাতিল করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW Game ID Input Modal -->
    <div class="modal fade" id="gameIdInputModalEl" tabindex="-1" aria-labelledby="gameIdInputModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gameIdInputModalLabel">আপনার গেম আইডি দিন</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary mb-3" id="gameIdInputDescriptionEl">টুর্নামেন্টে যোগ দেওয়ার জন্য আপনার গেম
                        আইডি প্রবেশ করান।</p>
                    <div id="gameIdInputsContainer" class="mb-3">
                        <!-- Dynamic input fields will be inserted here by JS -->
                    </div>
                    <div class="error-message" id="gameIdInputErrorEl" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">বাতিল করুন</button>
                    <button type="button" class="btn btn-custom btn-custom-primary"
                        id="confirmGameIdBtnEl">নিশ্চিত করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW Admin Support Modal -->
    <div class="modal fade" id="adminSupportModal" tabindex="-1" aria-labelledby="adminSupportModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminSupportModalLabel">Admin Support</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-secondary">যোগাযোগ করতে নিচের অপশনগুলি ব্যবহার করুন।</p>
                    <div class="admin-support-modal-icons" id="adminSupportIconsContainer">
                        <!-- Icons will be dynamically loaded here -->
                        <p class="text-muted">No support contacts configured.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Edit Profile Modal -->
    <div class="modal fade" id="editProfileModalEl" tabindex="-1" aria-labelledby="editProfileModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="editDisplayNameInputEl" class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="editDisplayNameInputEl"
                            placeholder="Enter new display name" required maxlength="50">
                    </div>
                    <hr class="border-secondary-subtle my-4">
                    <h6 class="text-primary mb-3">Change Password</h6>
                    <div class="form-group mb-3">
                        <label for="oldPasswordInputEl" class="form-label">Old Password</label>
                        <input type="password" class="form-control" id="oldPasswordInputEl" placeholder="Old Password">
                    </div>
                    <div class="form-group mb-3">
                        <label for="newPasswordInputEl" class="form-label">New Password (min 6 chars)</label>
                        <input type="password" class="form-control" id="newPasswordInputEl" placeholder="New Password"
                            minlength="6">
                    </div>
                    <div class="form-group mb-3">
                        <label for="confirmNewPasswordInputEl" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmNewPasswordInputEl"
                            placeholder="Confirm New Password">
                    </div>
                    <div class="error-message mt-3" id="editProfileErrorEl" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="saveProfileChangesBtnEl">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i
                class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="wallet-section"><i
                class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="earnings-section"><i
                class="bi bi-coin"></i><span>Earnings</span></button>
        <button class="nav-item" data-section="profile-section"><i
                class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"; // Added serverTimestamp
        // এই লাইনটি আপডেট করা হয়েছে: `updateProfile` এবং `updatePassword` যোগ করা হয়েছে
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, EmailAuthProvider, reauthenticateWithCredential, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; // Added EmailAuthProvider, reauthenticateWithCredential, updateProfile, updatePassword

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace the placeholder values below with your actual Firebase project configuration.
        // You can find these details in your Firebase project settings:
        // Project settings > General > Your apps > Web app > SDK setup and configuration > Config
        // ===============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCojg3-QA4GS3IVqw-P4-ZL_c3-HmdjYRM",
            authDomain: "fh-tournament-2.firebaseapp.com",
            databaseURL: "https://fh-tournament-2-default-rtdb.firebaseio.com",
            projectId: "fh-tournament-2",
            storageBucket: "fh-tournament-2.firebasestorage.app",
            messagingSenderId: "625965681991",
            appId: "1:625965681991:web:58d7c86a20dee8a20ad062",
            measurementId: "G-HN1C7T4PHL"
        };
        // =========================================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("Firebase config using placeholder values. Replace them with your actual project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized (check config if using placeholders)");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache ---
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
            sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
            headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
            loginSection: getElement('login-section'),
            // Login Form Elements
            emailLoginForm: getElement('emailLoginForm'),
            loginEmailInput: getElement('loginEmailInputEl'),
            loginPasswordInput: getElement('loginPasswordInputEl'),
            loginEmailBtn: getElement('loginEmailBtnEl'),
            showSignupToggleBtn: getElement('showSignupToggleBtnEl'),
            loginStatusMessage: getElement('loginStatusMessageEl'),
            forgotPasswordLink: getElement('forgotPasswordLinkEl'),
            // Signup Form Elements
            emailSignupForm: getElement('emailSignupForm'),
            signupNameInput: getElement('signupNameInputEl'), // <<< Added Name Input Element
            signupEmailInput: getElement('signupEmailInputEl'),
            signupPasswordInput: getElement('signupPasswordInputEl'),
            signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'),
            signupReferralCodeInput: getElement('signupReferralCodeInputEl'), // <<< Added Referral Code Input Element
            signupEmailBtn: getElement('signupEmailBtnEl'),
            showLoginToggleBtn: getElement('showLoginToggleBtnEl'),
            signupStatusMessage: getElement('signupStatusMessageEl'),
            homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
            tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
            walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
            // Deposit Section Elements
            depositSection: getElement('deposit-section'),
            depositPaymentTabs: querySelAll('#deposit-section .payment-tabs .tab-link'),
            bkashNumberDisplay: getElement('bkash-number'),
            nagadNumberDisplay: getElement('nagad-number'),
            rocketNumberDisplay: getElement('rocket-number'),
            minDepositDisplays: querySelAll('#deposit-section .min-deposit-display'),
            depositForms: querySelAll('#deposit-section .deposit-form'),

            // NEW Withdraw Section Elements
            withdrawSection: getElement('withdraw-section'),
            withdrawRulesDisplay: getElement('withdrawRulesDisplayEl'),
            withdrawPaymentTabs: querySelAll('#withdraw-section .payment-tabs .tab-link'),
            minWithdrawDisplaysWithdraw: querySelAll('#withdraw-section .min-withdraw-display-amount'),
            withdrawForms: querySelAll('#withdraw-section .withdraw-form'),

            earningsSection: getElement('earnings-section'), earningsTotal: getElement('earningsTotalEl'), earningsReferral: getElement('earningsReferralEl'), viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
            profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileTotalWinnings: getElement('profileTotalWinningsEl'), profileTotalBalance: getElement('profileTotalBalanceEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
            policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
            matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
            idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
            securityWarning: getElement('securityWarning'),

            // NEW: Match Type Selection Modal elements
            playerModeSelectionModalInstance: getElement('playerModeSelectionModalEl') ? new bootstrap.Modal(getElement('playerModeSelectionModalEl')) : null,
            playerModeSelectionModalLabel: getElement('playerModeSelectionModalLabel'),
            playerModeSelectionDescription: getElement('playerModeSelectionDescription'),
            playerModeOptionsContainer: getElement('playerModeOptionsContainer'),
            playerModeSelectionErrorEl: getElement('playerModeSelectionErrorEl'),

            // NEW: Game ID Input Modal elements
            gameIdInputModalInstance: getElement('gameIdInputModalEl') ? new bootstrap.Modal(getElement('gameIdInputModalEl')) : null,
            gameIdInputModalLabel: getElement('gameIdInputModalLabel'),
            gameIdInputDescriptionEl: getElement('gameIdInputDescriptionEl'),
            gameIdInputsContainer: getElement('gameIdInputsContainer'),
            gameIdInputEl: getElement('gameIdInputEl'),
            confirmGameIdBtnEl: getElement('confirmGameIdBtnEl'),
            gameIdInputErrorEl: getElement('gameIdInputErrorEl'),

            // NEW: Admin Support Modal elements
            adminSupportLink: getElement('adminSupportLink'),
            adminSupportModal: getElement('adminSupportModal'),
            adminSupportIconsContainer: getElement('adminSupportIconsContainer'),

            // NEW: Leaderboard Elements
            leaderboardLink: getElement('leaderboardLink'),
            leaderboardList: getElement('leaderboardListEl'),
            loadingLeaderboardMessage: getElement('loadingLeaderboardMessage'),
            noLeaderboardMessage: getElement('noLeaderboardMessage'),

            // NEW: Edit Profile Elements (replaces editDisplayName options)
            editProfileLink: getElement('editProfileLink'),
            editProfileModalInstance: getElement('editProfileModalEl') ? new bootstrap.Modal(getElement('editProfileModalEl')) : null,
            editDisplayNameInput: getElement('editDisplayNameInputEl'),
            oldPasswordInput: getElement('oldPasswordInputEl'),
            newPasswordInput: getElement('newPasswordInputEl'),
            confirmNewPasswordInput: getElement('confirmNewPasswordInputEl'),
            saveProfileChangesBtn: getElement('saveProfileChangesBtnEl'),
            editProfileError: getElement('editProfileErrorEl')
        };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null;
        let pendingJoinTournament = {
            tId: null,
            feePerPlayer: 0,
            totalCalculatedFee: 0,
            btnRef: null,
            tournamentMatchType: null, // The matchType set by admin for the tournament
            playerChosenMatchType: null, // The matchType chosen by the player (e.g., Solo even if tournament is Squad)
            tournamentData: null
        };

        // --- HARDCODED DEPOSIT & WITHDRAW CONFIGURATION (FALLBACKS) ---
        const depositConfig = {
            bkashNumber: "017XXXXXXXX",
            nagadNumber: "018XXXXXXXX",
            rocketNumber: "019XXXXXXXX",
            minDepositAmount: 50,
            minWithdrawAmount: 50
        };

        // =========================================================================
        // --- NEW: THEME MANAGEMENT ---
        // =========================================================================
        const defaultTheme = {
            '--primary-bg': '#0F172A',
            '--secondary-bg': '#1E293B',
            '--card-bg': '#1E293B',
            '--text-primary': '#E2E8F0',
            '--text-secondary': '#94A3B8',
            '--accent-color': '#FACC15',
            '--accent-gradient': 'linear-gradient(to right, #FACC15, #FBBF24)',
            '--primary-button-bg': '#3B82F6',
            '--border-color': '#334155',
            '--bottom-nav-bg': '#1E293B',
            '--success-color': '#10B981',
            '--danger-color': '#EF4444',
            '--warning-color': '#F59E0B',
            '--info-color': '#3B82F6'
        };

        /**
         * Applies a theme object to the document's root CSS variables.
         * @param {object | null} theme - The theme object with CSS variable keys and color values.
         * If null, it resets the theme to the stylesheet defaults.
         */
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme && typeof theme === 'object') {
                console.log("Applying custom theme:", theme);
                for (const property in defaultTheme) {
                    if (theme[property]) {
                        root.style.setProperty(property, theme[property]);
                    } else {
                        root.style.removeProperty(property);
                    }
                }
            } else {
                console.log("Resetting to default theme.");
                for (const property in defaultTheme) {
                    root.style.removeProperty(property);
                }
            }
        }
        // =========================================================================

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function showDepositAlert(message, type = 'danger') {
            const activeTabContent = querySel('#deposit-section .tab-content.active');
            const errorMessageEl = activeTabContent ? activeTabContent.querySelector('.error-message') : null;
            if (errorMessageEl) {
                errorMessageEl.textContent = message;
                errorMessageEl.style.color = type === 'danger' ? 'var(--danger-color)' : 'var(--success-color)';
            } else {
                alert(message);
            }
        }
        function clearDepositAlerts() {
            querySelAll('#deposit-section .error-message').forEach(el => el.textContent = '');
        }
        function showWithdrawAlert(message, type = 'danger') {
            const activeTabContent = querySel('#withdraw-section .tab-content.active');
            const errorMessageEl = activeTabContent ? activeTabContent.querySelector('.error-message') : null;
            if (errorMessageEl) {
                errorMessageEl.textContent = message;
                errorMessageEl.style.color = type === 'danger' ? 'var(--danger-color)' : 'var(--success-color)';
            } else {
                alert(message);
            }
        }
        function clearWithdrawAlerts() {
            querySelAll('#withdraw-section .error-message').forEach(el => el.textContent = '');
        }
        function showGameIdInputAlert(message, type = 'danger') {
            if (elements.gameIdInputErrorEl) {
                elements.gameIdInputErrorEl.textContent = message;
                elements.gameIdInputErrorEl.style.color = type === 'danger' ? 'var(--danger-color)' : 'var(--success-color)';
                elements.gameIdInputErrorEl.style.display = 'block';
            }
        }
        function clearGameIdInputAlert() {
            if (elements.gameIdInputErrorEl) {
                elements.gameIdInputErrorEl.textContent = '';
                elements.gameIdInputErrorEl.style.display = 'none';
            }
        }
        function showPlayerModeSelectionAlert(message, type = 'danger') {
            if (elements.playerModeSelectionErrorEl) {
                elements.playerModeSelectionErrorEl.textContent = message;
                elements.playerModeSelectionErrorEl.style.color = type === 'danger' ? 'var(--danger-color)' : 'var(--success-color)';
                elements.playerModeSelectionErrorEl.style.display = 'block';
            }
        }
        function clearPlayerModeSelectionAlert() {
            if (elements.playerModeSelectionErrorEl) {
                elements.playerModeSelectionErrorEl.textContent = '';
                elements.playerModeSelectionErrorEl.style.display = 'none';
            }
        }

        // NEW: Error message for Edit Profile Modal
        function showEditProfileError(message, type = 'danger') {
            if (elements.editProfileError) {
                elements.editProfileError.textContent = message;
                elements.editProfileError.style.color = type === 'danger' ? 'var(--danger-color)' : 'var(--success-color)';
                elements.editProfileError.style.display = 'block';
            }
        }

        function clearEditProfileError() {
            if (elements.editProfileError) {
                elements.editProfileError.textContent = '';
                elements.editProfileError.style.display = 'none';
            }
        }


        function copyToClipboard(targetSelector) {
            if (!targetSelector) { alert('Copy target not defined.'); return; }
            const targetElement = querySel(targetSelector);
            if (!targetElement) { alert('Element to copy from not found.'); return; }
            const textToCopy = targetElement.textContent;
            if (!textToCopy || textToCopy.trim() === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; }
            navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); });
        }
        function shareReferral(code) { if (!navigator.share) { alert('Web Share not supported. Copy the code manually.'); return; } if (!code || code === 'N/A') { alert('Referral code not available.'); return; } navigator.share({ title: 'Join Me on TOUR CLUB!', text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`, url: window.location.origin }).catch((error) => console.log('Error sharing', error)); }
        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };

        // --- UI Functions ---
        function showSection(sectionId) {
            if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
            const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
            const protectedSections = ['home-section', 'wallet-section', 'earnings-section', 'profile-section', 'tournaments-section', 'deposit-section', 'withdraw-section', 'leaderboard-section']; // Added leaderboard-section
            const isLoggedIn = !!currentUser;
            if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
            if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
            elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
            updateHeaderForSection(sectionId);
            elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            console.log(`Loading data for section: ${sectionId}`);
            switch (sectionId) {
                case 'home-section': loadHomePageData(); break;
                case 'wallet-section': loadWalletData(); break;
                case 'profile-section': loadProfileData(); break;
                case 'earnings-section': loadEarningsData(); break;
                case 'deposit-section': initDepositPageHardcoded(); break;
                case 'withdraw-section': initWithdrawPageHardcoded(); break;
                case 'leaderboard-section': loadLeaderboardData(); break; // Load leaderboard data
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }
            if (sectionId === 'login-section') { toggleLoginForm(true); }
            window.scrollTo(0, 0);
        }
        function updateHeaderForSection(sectionId) {
            const showBackButton = (sectionId === 'tournaments-section' || sectionId === 'deposit-section' || sectionId === 'withdraw-section' || sectionId === 'leaderboard-section'); // Added leaderboard-section
            const defaultTitleVisible = !showBackButton; const gameTitleVisible = showBackButton;
            if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
            if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
            if (gameTitleVisible && sectionId === 'tournaments-section' && currentTournamentGameId && elements.headerGameTitle) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                elements.headerGameTitle.textContent = gameName;
            } else if (gameTitleVisible && sectionId === 'deposit-section' && elements.headerGameTitle) {
                elements.headerGameTitle.textContent = 'Add Money';
            } else if (gameTitleVisible && sectionId === 'withdraw-section' && elements.headerGameTitle) {
                elements.headerGameTitle.textContent = 'Withdraw Funds';
            } else if (gameTitleVisible && sectionId === 'leaderboard-section' && elements.headerGameTitle) {
                elements.headerGameTitle.textContent = 'Leaderboard';
            }
            else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; }
        }
        function updateGlobalUI(isLoggedIn) {
            if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
            if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
            if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
            elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; });
        }
        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const balance = (profile.balance || 0);
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);
            const totalEarnings = (profile.totalEarnings || 0); // Correctly read totalEarnings from profile
            const referralEarnings = (profile.referralEarnings || 0);
            const totalMatches = profile.totalMatches || 0;
            const formatCurrency = (amount) => `৳${Math.round(amount)}`; // Updated to show rounded integer

            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance);
            if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); }
            if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); }
            if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); }
            
            // Profile Section Population
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) { 
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); }
            if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); }
            if (elements.profileTotalWinnings) { elements.profileTotalWinnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalWinnings.closest('.placeholder-glow')); } // Use totalEarnings here
            if (elements.profileTotalBalance) { elements.profileTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.profileTotalBalance.closest('.placeholder-glow')); }
            
            // Earnings Section Population (using totalEarnings for consistency)
            if (elements.earningsTotal) { elements.earningsTotal.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.earningsTotal.closest('.placeholder-glow')); }
            if (elements.earningsReferral) { elements.earningsReferral.textContent = formatCurrency(referralEarnings); removePlaceholders(elements.earningsReferral.closest('.placeholder-glow')); }
        }

        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
        async function signUpWithEmail() {
            if (!auth) return;
            const name = elements.signupNameInput.value.trim(); // Get the name
            const em = elements.signupEmailInput.value.trim();
            const pw = elements.signupPasswordInput.value;
            const cpw = elements.signupConfirmPasswordInput.value;
            const refCode = elements.signupReferralCodeInput.value.trim();

            if (!name || !em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Please fill all required fields.', 'warning'); return; } // Validate name
            if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
            if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }

            showLoader(true); clearStatusMessage(elements.signupStatusMessage);
            validReferrerUid = null;

            try {
                if (refCode) {
                    console.log("Validating referral code:", refCode);
                    const usersRef = ref(db, 'users');
                    const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));
                    const snapshot = await get(q);
                    if (snapshot.exists()) {
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0];
                        const referrerProfile = referrerData[referrerId];
                        if (referrerId && referrerProfile.email) {
                            validReferrerUid = referrerId;
                            console.log("Valid referrer found:", validReferrerUid);
                        } else {
                            console.warn("Referral code found, but referrer data invalid:", referrerData);
                        }
                    } else {
                        console.log("Referral code not found:", refCode);
                    }
                }
                const userCredential = await createUserWithEmailAndPassword(auth, em, pw);
                // After successful creation, update the user's profile with display name
                // v9 Syntax: updateProfile(user, { displayName: name });
                await updateProfile(userCredential.user, { displayName: name });


            } catch (e) {
                console.error("Signup Error:", e); let m = `Signup failed.`; switch (e.code) { case 'auth/email-already-in-use': m = 'Email already registered.'; break; case 'auth/weak-password': m = 'Password too weak.'; break; case 'auth/invalid-email': m = 'Invalid email.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.signupStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }
        async function loginWithEmail() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim();
            const pw = elements.loginPasswordInput.value;
            if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.loginStatusMessage);
            try { await signInWithEmailAndPassword(auth, em, pw); }
            catch (e) { console.error("Login Error:", e); let m = `Login failed.`; switch (e.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; case 'auth/invalid-email': m = 'Invalid email format.'; break; case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
            finally { showLoader(false); }
        }
        async function resetPassword() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim();
            if (!em) { showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.loginStatusMessage);
            try { await sendPasswordResetEmail(auth, em); showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); }
            catch (e) { console.error("Reset Pass Error:", e); let m = `Failed to send email.`; switch (e.code) { case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
            finally { showLoader(false); }
        }
        async function logoutUser() { if (!auth) return; try { showLoader(true); await signOut(auth); } catch (e) { console.error("Sign Out Error:", e); alert(`Logout failed: ${e.message}`); showLoader(false); } }

        // --- Auth State Change Handler ---
        async function handleAuthStateChange(user) {
            if (!auth || !db) {
                console.error("Firebase not ready in auth change");
                showLoader(false);
                return;
            }
            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            const localReferrerUid = validReferrerUid;
            validReferrerUid = null;

            if (user) {
                console.log("Auth State: Logged In", user.uid);
                const userRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        userProfile = snapshot.val();

                        // ***** ব্যান চেক করার জন্য কোড *****
                        if (userProfile.isBanned) {
                            console.warn("User is banned. Logging out.");
                            alert("আপনার অ্যাকাউন্টটি ব্যান করা হয়েছে। অ্যাডমিনের সাথে যোগাযোগ করুন।");
                            await logoutUser();
                            return;
                        }
                        // ************************************

                        const updates = {};
                        // Ensure displayName from auth is used if available and profile doesn't have it or is different
                        // v9 Syntax: user.displayName is directly accessible, but updateProfile is a function.
                        if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) updates.displayName = user.displayName;
                        if (user.email && !userProfile.email) updates.email = user.email;
                        if (Object.keys(updates).length > 0) {
                            await update(userRef, updates);
                            userProfile = { ...userProfile, ...updates };
                        }
                    } else {
                        // ***** নতুন ব্যবহারকারী, প্রোফাইল তৈরি এবং ত্রুটি হ্যান্ডলিং-এর উন্নত লজিক *****
                        console.log("New user, creating profile...");
                        const newUserProfile = {
                            uid: user.uid,
                            displayName: user.displayName || user.email?.split('@')[0] || 'User',
                            email: user.email || null,
                            photoURL: user.photoURL || null,
                            balance: appSettings.newUserBalance || 0,
                            winningCash: 0,
                            bonusCash: appSettings.newUserBonus || 0,
                            totalMatches: 0,
                            totalEarnings: 0,
                            referralEarnings: 0,
                            createdAt: Date.now(),
                            referralCode: generateReferralCode(),
                            joinedTournaments: {},
                            isAdmin: false,
                            isBanned: false, // ডিফল্টভাবে নতুন ব্যবহারকারী ব্যানড নয়
                            ...(localReferrerUid && { referredBy: localReferrerUid })
                        };

                        try {
                            // প্রথমে ব্যবহারকারীর মূল প্রোফাইল ডেটা Firebase Realtime Database-এ সেট করুন
                            await set(userRef, newUserProfile);
                            userProfile = newUserProfile; // সফল হলে userProfile আপডেট করুন

                            // সাইনআপ বোনাস যদি থাকে, সেটি রেকর্ড করার চেষ্টা করুন
                            if (newUserProfile.bonusCash > 0) {
                                try {
                                    await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                                } catch (bonusError) {
                                    console.error("Error recording signup bonus:", bonusError);
                                    alert("স্বাগত বোনাস যোগ করা যায়নি। অনুগ্রহ করে সাপোর্টে যোগাযোগ করুন।"); // ব্যবহারকারীকে জানান, কিন্তু লগআউট করবেন না
                                }
                            }

                            // রেফারেল বোনাস যদি থাকে, সেটি প্রয়োগ করার চেষ্টা করুন
                            if (localReferrerUid && appSettings.referralBonus > 0) {
                                try {
                                    console.log(`Awarding referral bonus of ৳${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                                    const referrerRef = ref(db, `users/${localReferrerUid}`);
                                    const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                        if (referrerData) {
                                            referrerData.balance = (referrerData.balance || 0) + appSettings.referralBonus;
                                            referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus;
                                            referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                        }
                                        return referrerData;
                                    });

                                    if (referrerUpdateResult.committed) {
                                        await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                                        console.log("Referrer bonus awarded successfully.");
                                    } else {
                                        console.warn("Referrer bonus transaction aborted (not committed).");
                                    }
                                } catch (referrerError) {
                                    console.error("Error awarding referrer bonus:", referrerError);
                                    alert("রেফারেল বোনাস প্রয়োগ করা যায়নি। অনুগ্রহ করে সাপোর্টে যোগাযোগ করুন।"); // ব্যবহারকারীকে জানান, কিন্তু লগআউট করবেন না
                                }
                            }

                            // যদি এই পর্যন্ত সফলভাবে চলে আসে, তবে ব্যবহারকারীকে লগইন সেশন দেওয়া হবে
                            // populateUserInfo(user, userProfile); // এটি নিচে একবার কল হবে, তাই এখানে ডুপ্লিকেট না করাই ভালো
                            // setupRealtimeListeners(user.uid); // এটিও নিচে কল হবে
                            // updateGlobalUI(true); // এটিও নিচে কল হবে
                            // const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                            // showSection(targetSection);

                        } catch (profileCreationError) {
                            // এটি শুধুমাত্র তখন চলবে যখন নতুন ব্যবহারকারীর প্রোফাইল ডেটা (set(userRef, newUserProfile)) তৈরি করতে ব্যর্থ হবে।
                            // এই ক্ষেত্রে ব্যবহারকারীর Auth অ্যাকাউন্ট তৈরি হলেও DB প্রোফাইলটি নেই, তাই লগআউট করা নিরাপদ।
                            console.error("CRITICAL: New user profile creation in DB failed:", profileCreationError);
                            alert("অ্যাকাউন্ট তৈরি হলেও প্রোফাইল ডেটা লোড করতে সমস্যা হয়েছে। আবার চেষ্টা করুন বা সাপোর্টে যোগাযোগ করুন। আপনাকে লগআউট করা হলো। Error: " + profileCreationError.message);
                            await logoutUser(); // যেহেতু মূল প্রোফাইল তৈরি হয়নি, তাই লগআউট করে দেওয়া হলো
                            return; // এই ফাংশনের বাকি অংশ চালানো বন্ধ করুন
                        }
                        // ***** নতুন ব্যবহারকারী তৈরির লজিক শেষ *****

                    }
                    // যদি snapshot.exists() ট্রু হয়, অর্থাৎ পুরানো ব্যবহারকারী হয়, তাহলে এখানে আসবে এবং এই কোডগুলি চলবে
                    // অথবা নতুন ব্যবহারকারী প্রোফাইল তৈরি সফল হলে এই কোডগুলি চলবে
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);
                } catch (error) {
                    // এই ক্যাচ ব্লকটি শুধুমাত্র সেই এররগুলি ধরবে যা উপরের try-catch ব্লকগুলি ধরতে পারেনি।
                    // যেমন, অথেনটিকেশন স্টেট হ্যান্ডলিং-এ কোনো অপ্রত্যাশিত এরর বা পুরানো ব্যবহারকারীর প্রোফাইল লোড করতে ব্যর্থ হলে।
                    console.error("Profile handling error (general catch):", error);
                    alert("প্রোফাইল লোড করতে সমস্যা হয়েছে। আপনাকে লগআউট করা হলো। Error: " + error.message);
                    try {
                        await logoutUser();
                    } catch (logoutErr) {}
                }
            } else {
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                showSection('login-section');
            }
            showLoader(false);
        }

        // --- Database Interaction Functions ---
        function loadAppSettings() {
            console.log("Attaching listener for App Settings...");
            const settingsRef = ref(db, 'settings');

            if (dbListeners['settings']) {
                off(settingsRef, 'value', dbListeners['settings'].func);
                delete dbListeners['settings'];
            }

            const settingsListener = onValue(settingsRef, (snapshot) => {
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    console.log("App Settings Updated (Real-time):", appSettings);

                    applyTheme(appSettings.theme || null);

                    if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;

                    if (elements.withdrawRulesDisplay) {
                        elements.withdrawRulesDisplay.innerHTML = appSettings.policyWithdrawal || '<p class="text-secondary text-center">টাকা তোলার কোনো নিয়মাবলী সেট করা হয়নি।</p>';
                    }
                    // Update Deposit Page dynamic values immediately
                    if (currentSectionId === 'deposit-section') {
                        initDepositPageHardcoded();
                    }
                    // Update Withdraw Page dynamic values immediately
                    if (currentSectionId === 'withdraw-section') {
                        initWithdrawPageHardcoded();
                    }

                } else {
                    console.warn("App Settings not found in database! Using defaults.");
                    appSettings = {};
                    applyTheme(null);
                    if (elements.withdrawRulesDisplay) {
                        elements.withdrawRulesDisplay.innerHTML = '<p class="text-secondary text-center">টাকা তোলার কোনো নিয়মাবলী সেট করা হয়নি।</p>';
                    }
                    // Apply default deposit/withdraw values if settings are not found
                    if (currentSectionId === 'deposit-section') {
                        initDepositPageHardcoded();
                    }
                    if (currentSectionId === 'withdraw-section') {
                        initWithdrawPageHardcoded();
                    }
                }
            }, (error) => {
                console.error("Settings listener failed", error);
                appSettings = {};
                applyTheme(null);
                if (elements.withdrawRulesDisplay) {
                    elements.withdrawRulesDisplay.innerHTML = '<p class="text-danger text-center">নিয়মাবলী লোড করতে ব্যর্থ।</p>';
                }
            });

            dbListeners['settings'] = { path: 'settings', func: settingsListener };
        }


        function loadHomePageData() {
            console.log("Loading Home Page Data...");
            if (!currentUser) {
                console.log("User not logged in, skipping home data load.");
                if (elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = '';
                if (elements.gamesList) elements.gamesList.innerHTML = '';
                if (elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>';
                return;
            }
            loadPromotions();
            loadGames();
            loadMyContests();
        }

        async function loadPromotions() {
            console.log("Loading Promotions...");
            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;
            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;

            const promoRef = ref(db, 'promotions');
            try {
                const snapshot = await get(promoRef);
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
                console.log(`Found ${activePromotions.length} active promotions.`);

                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '';

                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                        sliderWrapper.appendChild(slide);
                    });
                    if (swiperInstance) swiperInstance.destroy(true, true);
                    swiperInstance = new Swiper(elements.promotionSlider, {
                        loop: activePromotions.length > 1,
                        autoplay: { delay: 3500, disableOnInteraction: false },
                        pagination: { el: '.swiper-pagination', clickable: true },
                        slidesPerView: 1
                    });
                } else {
                    elements.promotionSlider.style.display = 'none';
                }
            } catch (e) {
                console.error("Promo load failed:", e);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
                elements.promotionSlider.style.display = 'block';
            }
        }

        async function loadGames() {
            console.log("Loading Games...");
            if (!elements.gamesList) return;
            elements.gamesList.classList.add('placeholder-glow');
            elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`;

            const gamesRef = ref(db, 'games');
            try {
                const snapshot = await get(gamesRef);
                const games = snapshot.val() || {};
                const activeGames = Object.entries(games)
                    .filter(([, game]) => game.imageUrl && game.name)
                    .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                console.log(`Found ${activeGames.length} active games.`);

                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '';

                if (activeGames.length > 0) {
                    if (!appSettings.games) appSettings.games = {};
                    activeGames.forEach(([gameId, game]) => {
                        appSettings.games[gameId] = { name: game.name };
                        const col = document.createElement('div');
                        col.className = 'col-6';
                        col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                        col.querySelector('.game-card').addEventListener('click', () => {
                            currentTournamentGameId = gameId;
                            loadTournamentsForGame(gameId, game.name);
                        });
                        elements.gamesList.appendChild(col);
                    });
                } else {
                    elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>';
                }
            } catch (e) {
                console.error("Games load failed:", e);
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>';
            }
        }

        function loadTournamentsForGame(gameId, gameName) {
            console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`);
            if (!elements.tournamentsSection) return;
            currentTournamentGameId = gameId;
            elements.tournamentTabs.forEach(t => t.classList.remove('active'));
            querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');
            showSection('tournaments-section');
            filterTournaments(gameId, 'upcoming');
        }

        async function filterTournaments(gameId, status) {
            console.log(`Filtering tournaments for game ${gameId} with status ${status}`);
            if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = '';
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`;
            elements.noTournamentsMessage.style.display = 'none';
            try {
                const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const s = await get(tQuery);
                const allT = s.val() || {};
                const fT = Object.entries(allT).filter(([, t]) => t.status === status).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0));
                console.log(`Found ${fT.length} tournaments matching criteria.`);

                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '';

                if (fT.length > 0) {
                    fT.forEach(([tId, t]) => {
                        const card = createTournamentCardElement(tId, t);
                        elements.tournamentsListContainer.appendChild(card);
                    });
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (e) {
                console.error(`Tournaments filter failed (${status}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
                elements.noTournamentsMessage.style.display = 'none';
            }
        }

        function createTournamentCardElement(tId, t) {
            const card = document.createElement('div'); card.className = 'tournament-card'; card.dataset.tournamentId = tId;
            const eFeePerPlayer = t.entryFee || 0;
            const pkPrize = t.perKillPrize || 0; const pPool = t.prizePool || 0;
            const sTime = t.startTime ? new Date(t.startTime) : null; const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
            const regP = t.registeredPlayers || {};

            // Calculate total registered players (slots used)
            let totalPlayersRegistered = 0;
            if (regP) {
                for (const userId in regP) {
                    const playerEntry = regP[userId];
                    const playersJoiningCount = { 'solo': 1, 'duo': 2, 'squad': 4 }[playerEntry.matchType || 'solo']; // Default to solo if matchType is missing
                    totalPlayersRegistered += playersJoiningCount;
                }
            }

            const maxP = t.maxPlayers || 0;
            const spotsL = maxP > 0 ? Math.max(0, maxP - totalPlayersRegistered) : Infinity;
            const isF = maxP > 0 && spotsL <= 0;
            const isJ = currentUser && userProfile?.joinedTournaments?.[tId]; // User has joined this tournament
            const canJ = !isJ && !isF && t.status === 'upcoming'; // User can join

            let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime);
            else if (t.status === 'ongoing') timerTxt = 'LIVE';
            else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';

            let spotsTxt = 'Unlimited Spots'; let progP = 0;
            if (maxP > 0) {
                spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${totalPlayersRegistered}/${maxP})`; // Use totalPlayersRegistered here
                progP = Math.min(100, (totalPlayersRegistered / maxP) * 100);
            }

            let actionButtonsHTML = '';
            let roomIdButtonHTML = '';

            // --- Existing Join/Joined/Disabled button logic ---
            if (isJ) {
                actionButtonsHTML += `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
            } else if (canJ) {
                actionButtonsHTML += `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee-per-player="${eFeePerPlayer}" data-match-type="${t.matchType}">${eFeePerPlayer > 0 ? 'Join' : 'Join Free'} <i class="bi bi-arrow-right-short"></i></button>`;
            } else {
                let disabledReason = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                actionButtonsHTML += `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disabledReason || 'N/A'}</button>`;
            }

            // --- Room ID button logic ---
            if (isJ && (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000))) {
                roomIdButtonHTML = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> Room ID</button>`;
            }

            card.innerHTML = `
                <div class="tournament-card-header">
                    <div class="tournament-card-tags">
                        ${t.matchType ? `<span>${t.matchType.toUpperCase()}</span>` : ''}
                        ${t.mode ? `<span>${t.mode}</span>` : ''}
                        ${t.map ? `<span>${t.map}</span>` : ''}
                        ${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}
                    </div>
                    <div class="tournament-card-timer">${timerTxt}</div>
                </div>
                <h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3>
                <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p>
                <div class="tournament-card-info">
                    <div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ৳${pPool}</strong></div>
                    <div class="info-item"><span>Per Kill</span><strong>৳${pkPrize}</strong></div>
                    <div class="info-item"><span>Entry Fee</span><strong class="${eFeePerPlayer > 0 ? 'text-info' : ''}">৳${eFeePerPlayer} (per player)</strong></div>
                </div>
                <div class="tournament-card-spots">
                    ${spotsTxt}
                    ${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}
                </div>
                <div class="tournament-card-actions">
                    <button class="btn btn-custom btn-sm btn-custom-secondary btn-details" data-tournament-id="${tId}">Details</button>
                    ${actionButtonsHTML}
                </div>
                ${roomIdButtonHTML}
            `;

            const jBtn = card.querySelector('.btn-join'); if (jBtn) jBtn.addEventListener('click', handleJoinTournamentClick);
            const dBtn = card.querySelector('.btn-details'); if (dBtn) dBtn.addEventListener('click', handleMatchDetailsClick);
            const ipBtn = card.querySelector('.btn-idpass'); if (ipBtn) ipBtn.addEventListener('click', handleIdPasswordClick);
            return card;
        }

        async function loadMyContests() {
            console.log("Loading My Contests...");
            if (!currentUser) { if (elements.myContestsList) removePlaceholders(elements.myContestsList); if (elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; }
            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            elements.myContestsList.classList.add('placeholder-glow');
            elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`;
            if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none';
            if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; console.log("No joined contests found for user."); return; }
            console.log(`Found ${joinedIds.length} joined contest IDs.`);
            try {
                const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(contestPromises);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                const contestCards = [];
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        if (t.status === 'upcoming' || t.status === 'ongoing') {
                            const tId = joinedIds[index];
                            contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) });
                        }
                    } else {
                        console.warn(`Joined tournament ${joinedIds[index]} not found in tournaments node.`);
                    }
                });
                contestCards.sort((a, b) => a.startTime - b.startTime);
                if (contestCards.length > 0) {
                    contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
                } else if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                    elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
                }
            } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; }
        }

        function loadWalletData() {
            console.log("Loading Wallet Data...");
            if (!currentUser) return;
            loadRecentTransactions();
        }
        function loadProfileData() {
            console.log("Loading Profile Data...");
            if (!currentUser) return;
            // Placeholders are removed in populateUserInfo now
        }
        function loadEarningsData() {
            console.log("Loading Earnings Data...");
            if (!currentUser) return;
            // Placeholders are removed in populateUserInfo now
        }

        async function loadLeaderboardData() {
            console.log("Loading Leaderboard Data...");
            if (!elements.leaderboardList) return;

            elements.leaderboardList.innerHTML = '';
            elements.leaderboardList.classList.add('placeholder-glow');
            elements.loadingLeaderboardMessage.style.display = 'block';
            elements.noLeaderboardMessage.style.display = 'none';

            // Add placeholder items
            for (let i = 0; i < 5; i++) {
                elements.leaderboardList.innerHTML += `
                    <div class="leaderboard-item d-flex align-items-center placeholder-glow">
                        <span class="placeholder rounded-circle me-3" style="width: 40px; height: 40px;"></span>
                        <span class="placeholder col-6 me-auto" style="height: 20px;"></span>
                        <span class="placeholder col-2" style="height: 20px;"></span>
                    </div>`;
            }

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                const allUsers = snapshot.val() || {};

                const players = Object.values(allUsers)
                    .filter(user => (user.totalEarnings || 0) > 0)
                    .sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0))
                    .slice(0, 20); // Get top 20 players

                removePlaceholders(elements.leaderboardList); // Remove placeholders
                elements.leaderboardList.innerHTML = ''; // Clear previous content

                if (players.length > 0) {
                    elements.loadingLeaderboardMessage.style.display = 'none';
                    players.forEach((player, index) => {
                        const rank = index + 1;
                        const displayName = player.displayName || player.email?.split('@')[0] || 'Anonymous';
                        const photoURL = player.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=40`;
                        const winnings = `৳${Math.round(player.totalEarnings || 0)}`;

                        const listItem = document.createElement('div');
                        listItem.className = 'leaderboard-item';

                        let rankContent = `<span class="leaderboard-rank">${rank}</span>`;
                        if (rank === 1) {
                            listItem.classList.add('top-1');
                            rankContent = `<span class="leaderboard-rank icon-rank"><i class="bi bi-award-fill text-accent"></i></span>`;
                        } else if (rank === 2) {
                            listItem.classList.add('top-2');
                            rankContent = `<span class="leaderboard-rank icon-rank"><i class="bi bi-award-fill"></i></span>`;
                        } else if (rank === 3) {
                            listItem.classList.add('top-3');
                            rankContent = `<span class="leaderboard-rank icon-rank"><i class="bi bi-award-fill" style="color: #a0522d;"></i></span>`;
                        }

                        listItem.innerHTML = `
                            ${rankContent}
                            <img src="${photoURL}" alt="${displayName}" class="leaderboard-avatar">
                            <span class="leaderboard-name">${displayName}</span>
                            <span class="leaderboard-winnings">${winnings}</span>
                        `;
                        elements.leaderboardList.appendChild(listItem);
                    });
                } else {
                    elements.noLeaderboardMessage.style.display = 'block';
                    elements.loadingLeaderboardMessage.style.display = 'none';
                    elements.noLeaderboardMessage.textContent = 'No players on the leaderboard yet.';
                }
            } catch (e) {
                console.error("Failed to load leaderboard:", e);
                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = '<p class="text-danger text-center p-3">Could not load leaderboard data.</p>';
                elements.loadingLeaderboardMessage.style.display = 'none';
                elements.noLeaderboardMessage.style.display = 'none';
            }
        }


        async function recordTransaction(userId, type, amount, description, details = {}) {
            if (!userId) return;
            const transactionRef = ref(db, `transactions/${userId}`);
            const newTransaction = { type, amount, description, timestamp: Date.now(), ...details };
            try {
                await push(transactionRef, newTransaction);
                console.log(`Transaction recorded: ${type}, Amount: ${amount}`);
            } catch (e) {
                console.error("Transaction record failed:", e);
            }
        }

        async function loadRecentTransactions() {
            console.log("Loading Recent Transactions...");
            if (!currentUser || !elements.recentTransactionsList) return; const limit = 5;
            elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`;
            if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; }
            try {
                const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
                const s = await get(transRef);
                const transactions = s.val() || {};
                const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                console.log(`Found ${sortedT.length} recent transactions.`);

                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = '';

                if (sortedT.length > 0) {
                    if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
                    sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}৳${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); });
                } else if (elements.noTransactionsMessage) {
                    elements.noTransactionsMessage.style.display = 'block';
                    elements.noTransactionsMessage.textContent = 'No recent transactions.';
                }
            } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; }
        }

        // --- CORE JOIN LOGIC ---
        async function executeJoinLogic(gameIds, matchType) {
            const { tId, totalCalculatedFee, btnRef, tournamentData } = pendingJoinTournament;

            btnRef.disabled = true;
            btnRef.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            const uRef = ref(db, `users/${currentUser.uid}`);
            const tRef = ref(db, `tournaments/${tId}`);
            let transactionCommitted = false;

            try {
                // Step 1: Deduct balance & add tournament to user's joined list
                const txResult = await runTransaction(uRef, (profileData) => {
                    if (!profileData) throw new Error("User profile missing.");
                    if ((profileData.balance || 0) < totalCalculatedFee) throw new Error("Insufficient balance.");
                    if (profileData.joinedTournaments?.[tId]) {
                        console.warn("Already joined (Tx check).");
                        return;
                    }
                    profileData.balance = (profileData.balance || 0) - totalCalculatedFee;
                    if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                    profileData.joinedTournaments[tId] = {
                        joinedAt: Date.now(),
                        gameIds: gameIds,
                        matchType: matchType
                    };
                    return profileData;
                });

                if (!txResult.committed) {
                    if (userProfile?.joinedTournaments?.[tId]) throw new Error("Already joined this tournament.");
                    throw new Error("Join transaction failed. Balance might be low.");
                }
                transactionCommitted = true;
                console.log("Balance transaction successful.");

                // Step 2: Add user to tournament's registered players list
                const snapshot = await get(tRef);
                if (!snapshot.exists()) throw new Error("Tournament not found after transaction.");
                const currentTournamentData = snapshot.val();
                if (currentTournamentData.status !== 'upcoming') throw new Error("Tournament closed after balance check.");

                let currentTotalSpotsTaken = 0;
                if (currentTournamentData.registeredPlayers) {
                    for (const userId in currentTournamentData.registeredPlayers) {
                        const playerEntry = currentTournamentData.registeredPlayers[userId];
                        currentTotalSpotsTaken += { 'solo': 1, 'duo': 2, 'squad': 4 }[playerEntry.matchType || 'solo'];
                    }
                }
                const playersJoiningCount = { 'solo': 1, 'duo': 2, 'squad': 4 }[matchType];
                if (currentTournamentData.maxPlayers > 0 && (currentTotalSpotsTaken + playersJoiningCount) > currentTournamentData.maxPlayers) {
                    throw new Error("Tournament became full during join process.");
                }

                const updates = {};
                updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = {
                    joinedAt: serverTimestamp(),
                    gameIds: gameIds,
                    matchType: matchType
                };
                await update(ref(db), updates);
                console.log("Successfully updated tournament registered players.");

                // Step 3: Increment user's totalMatches count
                await runTransaction(uRef, (profileData) => {
                    if (profileData) {
                        profileData.totalMatches = (profileData.totalMatches || 0) + 1;
                    }
                    return profileData;
                });
                console.log("User totalMatches incremented.");


                // Step 4: Record Transaction
                await recordTransaction(currentUser.uid, 'tournament_join', -totalCalculatedFee, `Joined: ${tournamentData.name || 'Tournament'} (${matchType.toUpperCase()})`, { tournamentId: tId });
                alert(`Successfully joined! ৳${totalCalculatedFee.toFixed(2)} deducted.`);

                // Step 5: Update UI
                if (currentSectionId === 'home-section') loadMyContests();
                if (currentSectionId === 'tournaments-section') filterTournaments(currentTournamentGameId, 'upcoming');

            } catch (e) {
                console.error("Join failed:", e);
                alert(`Failed: ${e.message}`);

                if (btnRef) {
                    btnRef.disabled = false;
                    btnRef.innerHTML = `${pendingJoinTournament.feePerPlayer > 0 ? 'Join' : 'Join Free'} <i class="bi bi-arrow-right-short"></i>`;
                }

                if (transactionCommitted) {
                    console.error("CRITICAL: Attempting to refund user due to error after balance deduction.");
                    try {
                        const refundTx = await runTransaction(uRef, (profileData) => {
                            if (profileData) {
                                profileData.balance = (profileData.balance || 0) + totalCalculatedFee;
                                if (profileData.joinedTournaments?.[tId]) {
                                    delete profileData.joinedTournaments[tId];
                                }
                            }
                            return profileData;
                        });
                        if (refundTx.committed) {
                            await recordTransaction(currentUser.uid, 'join_failed_refund', totalCalculatedFee, `Refund for failed join: ${tournamentData?.name || 'Tournament'}`);
                            alert("Join failed, but your balance was successfully refunded.");
                        } else {
                            throw new Error("Refund transaction failed.");
                        }
                    } catch (refundError) {
                        console.error("CRITICAL REFUND FAILED!", refundError);
                        alert(`Join failed. CRITICAL: Failed to refund balance (৳${totalCalculatedFee.toFixed(2)})! Please contact support immediately.`);
                    }
                }
            } finally {
                showLoader(false);
                if (elements.gameIdInputModalInstance) elements.gameIdInputModalInstance.hide();
                pendingJoinTournament = null;
            }
        }

        async function handleJoinTournamentClick(event) {
            if (!currentUser) { alert("Login to join."); showSection('login-section'); return; }

            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId;
            const feePerPlayer = parseFloat(btn.dataset.feePerPlayer || 0);
            const tournamentMatchType = btn.dataset.matchType;

            showLoader(true);
            try {
                const tournamentSnapshot = await get(ref(db, `tournaments/${tId}`));
                if (!tournamentSnapshot.exists()) throw new Error("Tournament not found.");
                const tournamentData = tournamentSnapshot.val();

                pendingJoinTournament = {
                    tId, feePerPlayer, btnRef: btn, tournamentMatchType,
                    playerChosenMatchType: null, totalCalculatedFee: 0, tournamentData
                };

                if (tournamentMatchType === 'solo') {
                    pendingJoinTournament.playerChosenMatchType = 'solo';
                    // === FIX START ===
                    // The typo 'pendingJoinJoinTournament' is corrected to 'pendingJoinTournament'
                    pendingJoinTournament.totalCalculatedFee = feePerPlayer * 1;
                    // === FIX END ===
                    showGameIdInputModal();
                } else {
                    showPlayerModeSelectionModal();
                }
            } catch (error) {
                console.error("Error preparing join flow:", error);
                alert(`Failed to prepare join: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = `${feePerPlayer > 0 ? 'Join' : 'Join Free'} <i class="bi bi-arrow-right-short"></i>`;
            } finally {
                showLoader(false);
            }
        }

        function showPlayerModeSelectionModal() {
            if (!elements.playerModeSelectionModalInstance) {
                alert("UI Error. Please refresh.");
                return;
            }

            const { tournamentMatchType, feePerPlayer } = pendingJoinTournament;
            const optionsContainer = elements.playerModeOptionsContainer;
            optionsContainer.innerHTML = '';
            clearPlayerModeSelectionAlert();

            const availableModes = [];
            if (['solo', 'duo', 'squad'].includes(tournamentMatchType)) availableModes.push('solo');
            if (['duo', 'squad'].includes(tournamentMatchType)) availableModes.push('duo');
            if (tournamentMatchType === 'squad') availableModes.push('squad');

            const uniqueAvailableModes = [...new Set(availableModes)];
            const sortedModes = ['solo', 'duo', 'squad'].filter(mode => uniqueAvailableModes.includes(mode));

            sortedModes.forEach(mode => {
                const playersCount = { 'solo': 1, 'duo': 2, 'squad': 4 }[mode];
                const fee = feePerPlayer * playersCount;
                const button = document.createElement('button');
                button.className = 'btn btn-custom btn-custom-secondary btn-lg';
                button.dataset.playerMode = mode;
                button.dataset.totalFee = fee;
                button.innerHTML = `Join as ${mode.toUpperCase()} (৳${fee.toFixed(2)})`;
                button.addEventListener('click', handlePlayerModeSelected);
                optionsContainer.appendChild(button);
            });

            elements.playerModeSelectionModalInstance.show();
        }

        function handlePlayerModeSelected(event) {
            const selectedMode = event.currentTarget.dataset.playerMode;
            const totalFee = parseFloat(event.currentTarget.dataset.totalFee);
            if (!selectedMode || isNaN(totalFee)) {
                showPlayerModeSelectionAlert('Invalid mode selected.', 'danger');
                return;
            }
            pendingJoinTournament.playerChosenMatchType = selectedMode;
            pendingJoinTournament.totalCalculatedFee = totalFee;
            elements.playerModeSelectionModalInstance.hide();
            showGameIdInputModal();
        }


        function showGameIdInputModal() {
            if (!elements.gameIdInputModalInstance) {
                alert("UI Error. Please refresh.");
                return;
            }
            const { playerChosenMatchType, totalCalculatedFee } = pendingJoinTournament;
            let modalTitle = '', modalDescription = '', numberOfInputs = 0;

            switch (playerChosenMatchType) {
                case 'solo':
                    modalTitle = 'Enter Your SOLO Game ID';
                    modalDescription = `Enter your Game ID to join this Solo tournament. Total entry fee: ৳${totalCalculatedFee.toFixed(2)}`;
                    numberOfInputs = 1;
                    break;
                case 'duo':
                    modalTitle = 'Enter Your DUO Game IDs';
                    modalDescription = `Enter your and your partner's Game ID. Total entry fee: ৳${totalCalculatedFee.toFixed(2)}`;
                    numberOfInputs = 2;
                    break;
                case 'squad':
                    modalTitle = 'Enter Your SQUAD Game IDs';
                    modalDescription = `Enter all 4 squad members' Game IDs. Total entry fee: ৳${totalCalculatedFee.toFixed(2)}`;
                    numberOfInputs = 4;
                    break;
                default:
                    showGameIdInputAlert('Unexpected error. Please try again.', 'danger');
                    return;
            }
            elements.gameIdInputModalLabel.textContent = modalTitle;
            elements.gameIdInputDescriptionEl.textContent = modalDescription;
            renderGameIdInputs(numberOfInputs, playerChosenMatchType);
            clearGameIdInputAlert();
            elements.gameIdInputModalInstance.show();
        }

        function renderGameIdInputs(count, matchType) {
            const container = elements.gameIdInputsContainer;
            container.innerHTML = '';
            const playerLabels = {
                'solo': ['Your Game ID'],
                'duo': ['Your Game ID', 'Partner\'s Game ID'],
                'squad': ['Player 1 ID', 'Player 2 ID', 'Player 3 ID', 'Player 4 ID']
            };
            for (let i = 0; i < count; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'form-group mb-2';
                const labelText = playerLabels[matchType]?.[i] || `Player ${i + 1} ID`;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control game-id-input';
                input.id = `gameIdInput-${i}`;
                input.placeholder = labelText;
                input.required = true;
                inputGroup.appendChild(input);
                container.appendChild(inputGroup);
            }
        }


        async function submitGameIdForJoin() {
            clearGameIdInputAlert();
            if (!pendingJoinTournament) {
                showGameIdInputAlert('An unexpected error occurred. Please try again.', 'danger');
                return;
            }
            const { playerChosenMatchType } = pendingJoinTournament;
            const inputElements = elements.gameIdInputsContainer.querySelectorAll('.game-id-input');
            const gameIdsArray = Array.from(inputElements).map(input => input.value.trim()).filter(id => id);
            const expectedPlayers = { 'solo': 1, 'duo': 2, 'squad': 4 }[playerChosenMatchType] || 0;

            if (gameIdsArray.length !== expectedPlayers) {
                showGameIdInputAlert(`Please provide exactly ${expectedPlayers} Game ID(s). You provided: ${gameIdsArray.length}`, 'danger');
                return;
            }
            if (gameIdsArray.some(id => id === '') || gameIdsArray.some(id => id.length === 0)) { // Ensure no empty strings
                showGameIdInputAlert('No Game ID field can be empty.', 'danger');
                return;
            }
            elements.gameIdInputModalInstance.hide();
            showLoader(true);
            await executeJoinLogic(gameIdsArray, playerChosenMatchType);
        }

        function handleWithdrawClick() {
            if (!currentUser) { alert("Login to withdraw."); showSection('login-section'); return; }
            showSection('withdraw-section');
        }

        async function submitWithdrawFormHandler(event) {
            event.preventDefault();
            showLoader(true);
            clearWithdrawAlerts();

            if (!currentUser) {
                showWithdrawAlert('Please login to withdraw.', 'danger');
                showLoader(false);
                return;
            }

            const form = event.target;
            const amountInput = form.querySelector('input[type="number"]');
            const userNumberInput = form.querySelector('input[type="text"]');
            const amount = parseFloat(amountInput.value);
            const userWithdrawNumber = userNumberInput.value.trim();
            const method = form.dataset.method;

            const minWithdrawAmount = appSettings.minWithdraw || depositConfig.minWithdrawAmount;

            if (isNaN(amount) || amount <= 0) {
                showWithdrawAlert('Please enter a valid amount.', 'danger');
                showLoader(false);
                return;
            }
            if (amount < minWithdrawAmount) {
                showWithdrawAlert(`Minimum withdrawal amount is ৳${minWithdrawAmount}.`, 'danger');
                showLoader(false);
                return;
            }
            if (amount > userProfile.winningCash) {
                showWithdrawAlert('Insufficient winning balance.', 'danger');
                showLoader(false);
                return;
            }
            if (!userWithdrawNumber) {
                showWithdrawAlert('Please enter your number.', 'danger');
                showLoader(false);
                return;
            }

            const uRef = ref(db, `users/${currentUser.uid}`);
            let transactionCommitted = false;
            let withdrawalKey = null;

            try {
                const txResult = await runTransaction(uRef, (prof) => {
                    if (prof) {
                        if ((prof.winningCash || 0) >= amount) {
                            prof.winningCash -= amount;
                            prof.balance -= amount;
                            return prof;
                        }
                    }
                    return; // Abort
                });

                if (!txResult.committed) {
                    throw new Error("Failed to update balance. Please check your winning cash and try again.");
                }
                transactionCommitted = true;

                const wrRef = ref(db, 'withdrawals');
                const newWithdrawalRef = await push(wrRef, {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    amount: amount,
                    method: method,
                    userWithdrawNumber: userWithdrawNumber,
                    status: 'pending',
                    requestTimestamp: serverTimestamp(),
                    userEmail: currentUser.email || 'N/A'
                });
                withdrawalKey = newWithdrawalRef.key;

                await recordTransaction(currentUser.uid, 'withdraw_request', -amount, `Withdrawal to ${userWithdrawNumber} (${method})`, { withdrawalId: withdrawalKey });

                showWithdrawAlert('Your withdrawal request has been submitted successfully!', 'success');
                form.reset();
                showSection('wallet-section');

            } catch (e) {
                console.error("Withdrawal error:", e);
                let errorMessage = `Error: ${e.message || 'An unexpected error occurred.'}`;

                if (transactionCommitted) {
                    console.warn("Attempting to refund user balance due to post-transaction error...");
                    try {
                        await runTransaction(uRef, (prof) => {
                            if (prof) {
                                prof.winningCash += amount;
                                prof.balance += amount;
                            }
                            return prof;
                        });
                        await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amount, `Refund for failed withdrawal`);
                        errorMessage += " Your balance has been refunded.";
                    } catch (refundError) {
                        console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError);
                        errorMessage += " CRITICAL: Failed to refund balance! Contact support immediately.";
                    }
                }
                showWithdrawAlert(errorMessage, 'danger');
            } finally {
                showLoader(false);
            }
        }


        async function handleMatchDetailsClick(event) {
            console.log("Match Details Clicked");
            if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return;
            elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.matchDetailsModalInstance.show();
            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const s = await get(tRef);
                if (s.exists()) {
                    const t = s.val();
                    const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
                    const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : 'TBA';
                    let pDistHTML = '';
                    if (t.prizeDistribution) {
                        let fmtDist = '';
                        if (typeof t.prizeDistribution === 'object') {
                            fmtDist = Object.entries(t.prizeDistribution)
                                .map(([rank, prize]) => `Rank ${rank}: ৳${prize}`)
                                .join('\n');
                        } else {
                            fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n');
                        }
                        pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`;
                    }
                    const desc = t.description || 'Standard rules apply.';
                    const fmtDesc = desc.replace(/\n/g, '<br>');
                    // Display Entry Fee per player only
                    elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Match Type:</strong> ${t.matchType ? t.matchType.toUpperCase() : 'N/A'}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><hr><p><strong>Entry Fee:</strong> ${t.entryFee > 0 ? `৳${t.entryFee} (per player)` : 'Free'}</p><p><strong>Prize:</strong> ৳${t.prizePool || 0}</p><p><strong>Per Kill:</strong> ৳${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`;
                } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
            } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; }
        }

        async function handleIdPasswordClick(event) {
            if (!elements.idPasswordModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
                alert("You must join the tournament to view the Room ID & Password.");
                return;
            }

            elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.idPasswordModalInstance.show();
            try {
                const tournamentRef = ref(db, `tournaments/${tId}`);
                const s = await get(tournamentRef);
                
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));

                if (s.exists()) {
                    const t = s.val();
                    if (t.showIdPass) {
                        elements.roomIdDisplay.textContent = t.roomId || 'Not set';
                        elements.roomPasswordDisplay.textContent = t.roomPassword || 'Not set';
                    } else {
                        elements.roomIdDisplay.textContent = 'Hidden';
                        elements.roomPasswordDisplay.textContent = 'Hidden';
                    }
                } else {
                    elements.roomIdDisplay.textContent = 'Not Found';
                    elements.roomPasswordDisplay.textContent = 'Not Found';
                }
            } catch (e) {
                console.error("ID/Pass fetch error:", e);
                elements.roomIdDisplay.textContent = 'Error';
                elements.roomPasswordDisplay.textContent = 'Error';
            }
        }

        async function handlePolicyClick(event) {
            if (!elements.policyModalInstance) return;
            event.preventDefault();
            const policyType = event.currentTarget.dataset.policy;
            if (!policyType) return;

            let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.policyModalBody.innerHTML = modalBodyContent;

            switch (policyType) {
                case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break;
                case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break;
                case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break;
                case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break;
                case 'refer':
                    title = 'Refer & Earn';
                    if (!currentUser) { alert("Login to view referral info."); return; }
                    const refCode = userProfile.referralCode || 'N/A';
                    const refBonus = appSettings?.referralBonus || 0;
                    const refDesc = appSettings?.referralDescription || `Get ৳${refBonus} when your friend joins using your code.`;
                    modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`;
                    break;
                default:
                    title = 'Info';
                    modalBodyContent = '<p>Content unavailable.</p>';
            }

            elements.policyModalTitle.textContent = title;
            elements.policyModalBody.innerHTML = policyType === 'refer' ? modalBodyContent : (modalBodyContent.replace(/\n/g, '<br>') || 'Not configured.');
            elements.policyModalInstance.show();
        }

        function initDepositPageHardcoded() {
            const settings = appSettings.depositSettings || {};
            const bkashNum = settings.bkashNumber || depositConfig.bkashNumber;
            const nagadNum = settings.nagadNumber || depositConfig.nagadNumber;
            const rocketNum = settings.rocketNumber || depositConfig.rocketNumber;
            const minDeposit = settings.minDepositAmount || depositConfig.minDepositAmount;

            if (elements.bkashNumberDisplay) elements.bkashNumberDisplay.textContent = bkashNum;
            if (elements.nagadNumberDisplay) elements.nagadNumberDisplay.textContent = nagadNum;
            if (elements.rocketNumberDisplay) elements.rocketNumberDisplay.textContent = rocketNum;
            elements.minDepositDisplays.forEach(el => { el.textContent = minDeposit; });
        }

        async function submitDepositFormHandler(e) {
            e.preventDefault();
            showLoader(true);
            clearDepositAlerts();

            if (!currentUser) {
                showDepositAlert('Please login to make a deposit.', 'danger');
                showLoader(false);
                return;
            }

            const form = e.target;
            const amountInput = form.querySelector('input[type="number"]');
            // === FIX START ===
            // The 'amount' variable was not declared. It is now correctly parsed from the amountInput.
            const amount = parseFloat(amountInput.value);
            // === FIX END ===
            const transactionId = form.querySelector('input[type="text"]').value.trim();
            const method = form.dataset.method;
            const minDeposit = appSettings.depositSettings?.minDepositAmount || depositConfig.minDepositAmount;

            if (isNaN(amount) || amount < minDeposit) {
                showDepositAlert(`Minimum deposit amount is ৳${minDeposit}.`, 'danger');
                showLoader(false);
                return;
            }
            if (!transactionId) {
                showDepositAlert('Please enter a valid Transaction ID.', 'danger');
                showLoader(false);
                return;
            }

            const depositData = {
                userId: currentUser.uid,
                userName: userProfile.displayName || currentUser.email,
                amount: amount,
                method: method,
                transactionId: transactionId,
                status: 'pending',
                requestTimestamp: serverTimestamp(),
                userEmail: currentUser.email || 'N/A'
            };
            try {
                const newDepositRef = push(ref(db, 'deposits'), depositData);
                await set(ref(db, `users/${currentUser.uid}/deposits/${newDepositRef.key}`), depositData);
                showDepositAlert('Deposit request submitted! Awaiting approval.', 'success');
                form.reset();
                showSection('wallet-section');
            } catch (error) {
                console.error("Error submitting deposit: ", error);
                showDepositAlert('Failed to submit deposit request. Please try again.', 'danger');
            } finally {
                showLoader(false);
            }
        }


        function initWithdrawPageHardcoded() {
            const minWithdraw = appSettings.minWithdraw || depositConfig.minWithdrawAmount;
            elements.minWithdrawDisplaysWithdraw.forEach(el => { el.textContent = minWithdraw; });
            if (elements.withdrawRulesDisplay) {
                elements.withdrawRulesDisplay.innerHTML = appSettings.policyWithdrawal || '<p class="text-secondary text-center">Withdrawal rules are not set.</p>';
            }
        }

        async function openAdminSupportModal() {
            const container = elements.adminSupportIconsContainer;
            container.innerHTML = '';
            const settings = appSettings.adminSupport || {};
            const links = [
                { id: 'tiktok', icon: 'fa-tiktok', url: settings.tiktok, label: 'TikTok' },
                { id: 'facebook', icon: 'bi-facebook', url: settings.facebook, label: 'Facebook' },
                { id: 'twitter', icon: 'fa-twitter', url: settings.twitter, label: 'Twitter' },
                { id: 'instagram', icon: 'fa-instagram', url: settings.instagram, label: 'Instagram' },
                { id: 'gmail', icon: 'bi-envelope-fill', url: settings.gmail, label: 'Gmail', mailto: true },
                { id: 'telegram', icon: 'bi-telegram', url: settings.telegram, label: 'Telegram' },
                { id: 'whatsapp', icon: 'bi-whatsapp', url: settings.whatsapp, label: 'WhatsApp' }
            ];

            let hasLinks = false;
            links.forEach(link => {
                if (link.url) {
                    hasLinks = true;
                    let finalUrl = link.url.trim();
                    if (link.mailto && !finalUrl.startsWith('mailto:')) finalUrl = `mailto:${finalUrl}`;
                    else if (link.id === 'whatsapp' && !finalUrl.startsWith('https://wa.me/')) finalUrl = `https://wa.me/${finalUrl.replace(/\D/g, '')}`;
                    else if (!link.mailto && !finalUrl.startsWith('http')) finalUrl = `https://${finalUrl}`;

                    const a = document.createElement('a');
                    a.href = finalUrl;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    const iconClass = link.icon.startsWith('fa-') ? `fa-brands ${link.icon}` : `bi ${link.icon}`;
                    a.innerHTML = `<i class="${iconClass}"></i><span>${link.label}</span>`;
                    container.appendChild(a);
                }
            });

            if (!hasLinks) container.innerHTML = '<p class="text-muted col-12">No support contacts configured.</p>';
            new bootstrap.Modal(elements.adminSupportModal).show();
        }

        // --- Realtime Listeners Setup ---
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return;
            detachAllDbListeners();
            console.log("Setting up realtime listener for User Profile:", uid);
            const userProfileRef = ref(db, `users/${uid}`);
            const userProfileListener = onValue(userProfileRef, (s) => {
                if (currentUser && currentUser.uid === uid && s.exists()) {
                    console.log("Realtime: User Profile Update Received");
                    userProfile = s.val();
                    populateUserInfo(currentUser, userProfile);
                } else if (!s.exists()) {
                    console.warn("User data deleted (realtime) for:", uid);
                    alert("Account data missing or deleted. Logging out.");
                    logoutUser();
                }
            }, (e) => {
                console.error("Listener error (user profile):", e);
            });
            dbListeners['userProfile'] = { path: `users/${uid}`, func: userProfileListener };

            loadAppSettings(); // Also keep app settings in sync
        }

        function detachAllDbListeners() {
            console.log("Detaching listeners:", Object.keys(dbListeners));
            for (const k in dbListeners) {
                try {
                    const { path, func } = dbListeners[k];
                    off(ref(db, path), 'value', func);
                } catch (e) { console.error(`Detach error for ${k}:`, e); }
            }
            dbListeners = {};
        }

        function setupTabSwitching(containerId, contentSelector) {
            const container = getElement(containerId);
            if (!container) return;
            container.addEventListener('click', (e) => {
                if (e.target.matches('.tab-link')) {
                    const targetId = e.target.dataset.tabTarget;
                    container.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
                    e.target.classList.add('active');
                    querySelAll(contentSelector).forEach(c => {
                        c.classList.toggle('active', c.id === targetId);
                        c.classList.toggle('d-none', c.id !== targetId);
                    });
                }
            });
        }

        // NEW: Function to handle saving profile changes (name and/or password)
        async function handleSaveProfileChanges() {
            if (!currentUser) {
                showEditProfileError('You must be logged in to edit your profile.', 'danger');
                return;
            }

            const newDisplayName = elements.editDisplayNameInput.value.trim();
            const oldPassword = elements.oldPasswordInput.value;
            const newPassword = elements.newPasswordInput.value;
            const confirmNewPassword = elements.confirmNewPasswordInput.value;

            clearEditProfileError();
            let changesMade = false;

            showLoader(true);

            try {
                // 1. Handle Display Name Change
                if (newDisplayName && newDisplayName !== userProfile.displayName) {
                    if (newDisplayName.length < 3 || newDisplayName.length > 50) {
                        showEditProfileError('Display name must be between 3 and 50 characters.', 'danger');
                        showLoader(false);
                        return;
                    }
                    console.log("Updating display name...");
                    // v9 Syntax: updateProfile(user, { displayName: name });
                    await updateProfile(currentUser, { displayName: newDisplayName }); // <-- এই লাইনটি পরিবর্তন করা হয়েছে
                    await update(ref(db, `users/${currentUser.uid}`), { displayName: newDisplayName }); // Realtime Database-ও আপডেট করুন
                    userProfile.displayName = newDisplayName; // Update local state
                    changesMade = true;
                }

                // 2. Handle Password Change
                if (oldPassword || newPassword || confirmNewPassword) { // If any password field is touched
                    if (!oldPassword) {
                        showEditProfileError('Old password is required to change password.', 'danger');
                        showLoader(false);
                        return;
                    }
                    if (!newPassword) {
                        showEditProfileError('New password cannot be empty.', 'danger');
                        showLoader(false);
                        return;
                    }
                    if (newPassword.length < 6) {
                        showEditProfileError('New password must be at least 6 characters long.', 'danger');
                        showLoader(false);
                        return;
                    }
                    if (newPassword !== confirmNewPassword) {
                        showEditProfileError('New password and confirm password do not match.', 'danger');
                        showLoader(false);
                        return;
                    }
                    if (oldPassword === newPassword) {
                        showEditProfileError('New password cannot be the same as old password.', 'warning');
                        showLoader(false);
                        return;
                    }

                    console.log("Updating password...");
                    const credential = EmailAuthProvider.credential(currentUser.email, oldPassword);
                    await reauthenticateWithCredential(currentUser, credential); // Re-authenticate
                    // v9 Syntax: updatePassword(user, newPassword);
                    await updatePassword(currentUser, newPassword); // <-- এই লাইনটি পরিবর্তন করা হয়েছে
                    changesMade = true;
                }

                if (changesMade) {
                    populateUserInfo(currentUser, userProfile); // Refresh UI with new data
                    alert('Profile updated successfully!');
                    elements.editProfileModalInstance.hide();
                } else {
                    showEditProfileError('No changes were made.', 'warning');
                }

            } catch (error) {
                console.error("Error saving profile changes:", error);
                let errorMessage = `Failed to update profile: ${error.message}`;
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect old password.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Please log in again to change your password.';
                }
                showEditProfileError(errorMessage, 'danger');
            } finally {
                showLoader(false);
            }
        }


        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            console.log("Initializing listeners...");
            document.body.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem) { showSection(navItem.dataset.section); return; }

                const tabItem = e.target.closest('.tournament-tabs .tab-item');
                if (tabItem) {
                    const status = tabItem.dataset.status;
                    if (currentTournamentGameId) {
                        document.querySelectorAll('.tournament-tabs .tab-item').forEach(t => t.classList.remove('active'));
                        tabItem.classList.add('active');
                        filterTournaments(currentTournamentGameId, status);
                    }
                    return;
                }
                if (e.target.closest('.copy-btn')) {
                    const targetSelector = e.target.closest('.copy-btn').dataset.target;
                    if (targetSelector) copyToClipboard(targetSelector);
                    return;
                }
                if (e.target.closest('#shareReferralBtn')) {
                    const codeEl = getElement('referralCodeDisplay');
                    if (codeEl) shareReferral(codeEl.textContent);
                    return;
                }
            });

            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', () => { if (currentUser) showSection('deposit-section'); else { alert("Login first."); showSection('login-section'); } });
            elements.confirmGameIdBtnEl?.addEventListener('click', submitGameIdForJoin);
            elements.adminSupportLink?.addEventListener('click', openAdminSupportModal);
            elements.leaderboardLink?.addEventListener('click', () => { if (currentUser) showSection('leaderboard-section'); else { alert("Login first."); showSection('login-section'); } }); // Leaderboard link listener

            // Adding submit listeners to deposit forms
            elements.depositForms.forEach(form => form.addEventListener('submit', submitDepositFormHandler));

            setupTabSwitching('depositPaymentTabsContainer', '#deposit-section .tab-content');
            setupTabSwitching('withdrawPaymentTabsContainer', '#withdraw-section .tab-content');

            // NEW: Edit Profile Link & Save Changes Listener
            elements.editProfileLink?.addEventListener('click', () => {
                if (!currentUser) {
                    alert("Login to edit your profile.");
                    showSection('login-section');
                    return;
                }
                // Pre-fill current display name
                if (elements.editDisplayNameInput) elements.editDisplayNameInput.value = userProfile.displayName || '';
                // Clear password fields
                if (elements.oldPasswordInput) elements.oldPasswordInput.value = '';
                if (elements.newPasswordInput) elements.newPasswordInput.value = '';
                if (elements.confirmNewPasswordInput) elements.confirmNewPasswordInput.value = '';
                clearEditProfileError(); // Clear any previous errors
                elements.editProfileModalInstance?.show();
            });
            elements.saveProfileChangesBtn?.addEventListener('click', handleSaveProfileChanges);


            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Initializing App...");
            if (!db || !auth) {
                console.error("Firebase SDK failed to initialize. Cannot proceed.");
                return;
            }
            showLoader(true);
            initializeEventListeners();
            updateGlobalUI(false);
            onAuthStateChanged(auth, handleAuthStateChange);
        });

    </script>

</body>

</html>
